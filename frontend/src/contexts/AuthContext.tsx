import { createContext, useContext, useState, useEffect } from "react";
import type { ReactNode } from "react";
import type { UserResponse } from "../api/auth";
import { login as apiLogin, register as apiRegister, getCurrentUser, saveToken, removeToken, getToken } from "../api/auth";

interface AuthContextType {
    user: UserResponse | null;
    loading: boolean;
    login: (username: string, password: string) => Promise<void>;
    register: (username: string, fullName: string, password: string, passwordConfirm: string) => Promise<void>;
    logout: () => void;
    isAuthenticated: boolean;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider = ({ children }: { children: ReactNode }) => {
    const [user, setUser] = useState<UserResponse | null>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        console.log("ðŸ” AuthProvider: Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ...");
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½
        const token = getToken();
        if (token) {
            console.log("ðŸ”‘ Ð¢Ð¾ÐºÐµÐ½ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ...");
            // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ
            getCurrentUser()
                .then((userData) => {
                    console.log("âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½:", userData);
                    setUser(userData);
                })
                .catch((error) => {
                    // Ð•ÑÐ»Ð¸ Ñ‚Ð¾ÐºÐµÐ½ Ð½ÐµÐ²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ð¹, ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÐµÐ³Ð¾
                    console.warn("âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½:", error);
                    removeToken();
                    setUser(null);
                })
                .finally(() => {
                    setLoading(false);
                    console.log("ðŸ AuthProvider: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°");
                });
        } else {
            console.log("ðŸ”“ Ð¢Ð¾ÐºÐµÐ½ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½");
            setLoading(false);
        }
    }, []);

    const login = async (username: string, password: string) => {
        const tokenResponse = await apiLogin({ username, password });
        saveToken(tokenResponse.access_token);
        const userData = await getCurrentUser();
        setUser(userData);
    };

    const register = async (username: string, fullName: string, password: string, passwordConfirm: string) => {
        await apiRegister({ username, full_name: fullName, password, password_confirm: passwordConfirm });
        // ÐŸÐ¾ÑÐ»Ðµ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ñ…Ð¾Ð´Ð¸Ð¼
        await login(username, password);
    };

    const logout = () => {
        removeToken();
        setUser(null);
    };

    return (
        <AuthContext.Provider
            value={{
                user,
                loading,
                login,
                register,
                logout,
                isAuthenticated: !!user,
            }}
        >
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = () => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error("useAuth must be used within an AuthProvider");
    }
    return context;
};

